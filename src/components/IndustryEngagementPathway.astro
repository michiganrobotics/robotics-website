---
import { Image } from "astro:assets";
import pathwaySpeaker from "../images/partnerships/pathway-speaker.jpg";
import studentTeams from "../images/partnerships/student-teams.jpg";
import careerFair from "../images/partnerships/career-fair.jpg";
import mdp from "../images/partnerships/mdp.jpg";
import iucrc from "../images/partnerships/iucrc.jpg";
import centersChairs from "../images/partnerships/centers-chairs.jpg";
import sponsoredResearch from "../images/partnerships/sponsored-research.jpg";
import { YouTube } from "astro-embed";

const engagementPoints = [
  {
    title: "Pathways speaker",
    description: "Share industry insights through our speaker series.",
    level: "Initial",
    media: {
      type: "image",
      src: pathwaySpeaker,
      alt: "Industry leader shares insights to a crowd at Robotics Pathways Speaker Series",
      description: "Previous speakers include leaders from Boston Dynamics, NASA JPL, Ford, and other leading robotics organizations. View the <a href='/academics/undergraduate/robotics-pathways-speaker-series/'>Pathway Speaker Series</a> page for more information."
    }
  },
  {
    title: "Student teams",
    description: "Support and mentor student robotics projects.",
    level: "Initial",
    media: {
      type: "image", 
      src: studentTeams,
      alt: "A Michigan Mars Rover team member drives the rover over the Mars Yard outside the Robotics Building",
      description: "Support teams like M-Fly, MRacing, Michigan Mars Rover, and Michigan Autonomous Aerial Vehicles. Read more about <a href='/people/student-teams'>our student teams</a>."
    }
  },
  {
    title: "Career fairs",
    description: "Connect directly with top robotics talent.",
    level: "Mid-Level",
    media: {
      type: "image", 
      src: careerFair,
      alt: "U-M students visit a table at the Robotics Career Fair to talk to industry representatives",
      description: "Attend Robotics career fairs to meet rising robotics talent for internships and full-time positions."
    }
  },
  {
    title: "ROB 450 and ROB 590",
    description: "Participate in senior-level and graduate-level robotics courses.",
    level: "Mid-Level",
    media: {
      type: "video", 
      src: "NbtS0mG2iXc",
      alt: "A video on ROB 450 that shows the course projects",
      description: "Students complete projects putting their knowledge to use in industry-relevant contexts."
    }
  },
  {
    title: "Multidisciplinary Design Program",
    description: "Collaborate on Michigan Design Program projects.",
    level: "Mid-Level",
    media: {
      type: "image", 
      src: mdp,
      alt: "A Spot quadruped robot helps students with an agricultural project",
      description: "Collaborate on MDP projects, which form an entire course around industry projects. Read more about the <a href='https://mdp.engin.umich.edu/'>program</a>."
    }
  },
  {
    title: "Sponsored research",
    description: "Funded research projects to advance robotics.",
    level: "Advanced",
    media: {
      type: "image", 
      src: sponsoredResearch,
      alt: "An autonomous vehicles drives around Mcity",
      description: "Projects can range in scope from an exploratory effort to a multi-year, joint engagement."
    }
  },
  {
    title: "Industry-University Research Partnerships",
    description: "Join our Industry-University Research Centers.",
    level: "Advanced",
    media: {
      type: "image", 
      src: iucrc,
      alt: "A robotic knee prosthetic is displayed at an international conference",
      description: "National Science Foundation IUCRCs tackle national challenges in robotics with  many benefits to industry. Read about one focused on <a href='https://sites.google.com/umich.edu/digitaltwincenter/home'>Digital Twins in Manufacturing</a> and one on <a href='https://robotics.umich.edu/2023/u-m-partners-with-autonomous-air-mobility-center/'>Autonomous Air Mobility</a>."
    }
  },
  {
    title: "Centers, chairs, and facilities",
    description: "Fund and access research facilities and establish collaborations.",
    level: "Advanced",
    media: {
      type: "image", 
      src: centersChairs,
      alt: "An aerial view of North Campus at the University of Michigan",
      description: "Roboticists at Michigan are changing the shape of the future: we are looking to invite major partners to realize our vision."
    }
  }
];

const groupedPoints = {
  "Initial": engagementPoints.filter(p => p.level === "Initial"),
  "Mid-Level": engagementPoints.filter(p => p.level === "Mid-Level"),
  "Advanced": engagementPoints.filter(p => p.level === "Advanced")
};
function getHrClass(level: string) {
    switch(level) {
      case 'Initial': return 'hr-initial';
      case 'Mid-Level': return 'hr-mid-level';
      case 'Advanced': return 'hr-advanced';
      default: return '';
    }
  }
---
<div class="max-w-6xl mx-auto p-6">
  <div id="main-content" class="relative space-y-12">
    {Object.entries(groupedPoints).map(([level, points], levelIndex) => (
      <section class="engagement-level relative">
        <div class="flex items-center gap-4 mb-6">
          <h3 class="text-xl font-bold text-neutral-900 dark:text-neutral-100 whitespace-nowrap not-prose font-roboto-condensed">{level}</h3>
          <hr class={`flex-grow h-0.5 border-0 not-prose ${getHrClass(level)}`} />
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          {points.map((point) => (
            <div 
              class="engagement-point" 
              role="button"
              aria-labelledby={`engagement-title-${point.title.toLowerCase().replace(/\s+/g, '-')}`}
              tabindex="0"
              aria-expanded="false"
              aria-controls={`content-${point.title.toLowerCase().replace(/\s+/g, '-')}`}
              aria-haspopup="true"
            >
              <div class={`engagement-point-content card-base card-hover surface p-4 ${level === 'Initial' ? 'border border-maize' : ''} ${level === 'Mid-Level' ? 'border border-taubmanTeal' : ''} ${level === 'Advanced' ? 'border border-arboretumBlue' : ''}`}>
                <div class="flex items-start gap-3">
                  <div class={`w-3 h-3 mt-1.5 rounded-full transition-colors duration-300 ${level === 'Initial' ? 'bg-maize dark:bg-maize' : ''} ${level === 'Mid-Level' ? 'bg-taubmanTeal' : ''} ${level === 'Advanced' ? 'bg-arboretumBlue' : ''}`}></div>
                  <div class="w-full">
                    <h4 id={`engagement-title-${point.title.toLowerCase().replace(/\s+/g, '-')}`} class="font-bold text-neutral-900 dark:text-neutral-100 not-prose">{point.title}</h4>
                    <p class="text-sm text-neutral-800 dark:text-neutral-100 not-prose">{point.description}</p>
                  </div>
                </div>
                {point.media && (
                  <div 
                    id={`content-${point.title.toLowerCase().replace(/\s+/g, '-')}`}
                    role="region" 
                    class="engagement-point-media mt-4 space-y-3"
                    aria-labelledby={`engagement-title-${point.title.toLowerCase().replace(/\s+/g, '-')}`}
                  >
                    {point.media.type === "image" && (
                      <div class="rounded-lg overflow-hidden">
                        <Image 
                          src={point.media.src} 
                          alt={point.media.alt} 
                          class="w-full h-48 object-cover" 
                          width={1200} 
                          height={630}
                          format="webp"
                          quality={80}
                        />
                        <p class="text-sm text-neutral-700 dark:text-neutral-100 mt-2" set:html={point.media.description}></p>
                      </div>
                    )}
                    {point.media.type === "video" && (
                      <>
                        <YouTube id={point.media.src} class="w-full aspect-video" />
                        <p class="text-sm text-neutral-700 dark:text-neutral-100 mt-2" set:html={point.media.description}></p>
                      </>
                    )}
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>
      </section>
    ))}
  </div>
</div>

<style>
  .engagement-point {
    transition: margin-bottom 0.3s ease;
    -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
  }
  .engagement-point-content {
    transition: all 0.3s ease;
    color: #333;
    cursor: pointer;
  }
  .engagement-point:hover .engagement-point-content,
  .engagement-point.expanded .engagement-point-content,
  .engagement-point:focus-within .engagement-point-content {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  .engagement-point-media {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, opacity 0.3s ease;
  }
  .engagement-point:hover .engagement-point-media,
  .engagement-point.expanded .engagement-point-media,
  .engagement-point:focus-within .engagement-point-media {
    max-height: 400px;
    opacity: 1;
  }
  .hr-initial {
    background: linear-gradient(to right, #ffcb05, transparent);
  }
  .hr-mid-level {
    background: linear-gradient(to right, #00B2A9, transparent);
  }
  .hr-advanced {
    background: linear-gradient(to right, #2F65A7, transparent);
  }
    
  /* Only apply hover effects on devices that support hover */
  @media (hover: hover) {
    .engagement-point:hover .engagement-point-media {
      max-height: 400px ;
      opacity: 1 ;
    }
  }

  /* Remove focus outline on mobile */
  @media (hover: none) {
    .engagement-point:focus {
      outline: none;
    }
    .engagement-point:focus-within {
      outline: none;
    }
  }

  /* Keep focus outline for keyboard navigation on desktop */
  @media (hover: hover) {
    .engagement-point:focus-within {
      outline: 2px solid var(--focus-ring-color-light);
      outline-offset: 2px;
      position: relative;
      z-index: 10; /* Ensure focused item appears above others */
    }
  }

  @media (prefers-color-scheme: dark) {
    .engagement-point-content {
      color: #f0f0f0;
    }
    .hr-initial {
      background: linear-gradient(to right, #ffcb05, transparent);
    }
    .hr-mid-level {
      background: linear-gradient(to right, #75988d, transparent);
    }
    .hr-advanced {
      background: linear-gradient(to right, #2F65A7, transparent);
    }
    
    /* Dark mode focus style */
    @media (hover: hover) {
      .engagement-point:focus-within {
        outline: 2px solid var(--focus-ring-color-dark);
        outline-offset: 2px;
        position: relative;
        z-index: 10; /* Ensure focused item appears above others */
      }
    }
  }
</style>

<script>
  document.querySelectorAll('.engagement-point').forEach((point: HTMLElement) => {
    let isExpanded = false;
    const isMobile = window.matchMedia('(hover: none)').matches;

    // Function to toggle expansion state
    const toggleExpansion = function(this: HTMLElement, e?: Event) {
      if (e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      const mediaContent = this.querySelector('.engagement-point-media') as HTMLElement;
      
      // Toggle the current point
      isExpanded = !isExpanded;
      this.classList.toggle('expanded');
      this.setAttribute('aria-expanded', String(isExpanded));
      
      if (isExpanded) {
        mediaContent.style.maxHeight = `${mediaContent.scrollHeight}px`;
        mediaContent.style.opacity = '1';
      } else {
        mediaContent.style.maxHeight = '0';
        mediaContent.style.opacity = '0';
      }
      
      // Close other points
      document.querySelectorAll('.engagement-point').forEach((otherPoint: HTMLElement) => {
        if (otherPoint !== this) {
          const otherMedia = otherPoint.querySelector('.engagement-point-media') as HTMLElement;
          if (otherMedia) {
            otherPoint.classList.remove('expanded');
            otherPoint.setAttribute('aria-expanded', 'false');
            otherMedia.style.maxHeight = '0';
            otherMedia.style.opacity = '0';
          }
        }
      });
    };

    // Handle click/tap events
    point.addEventListener('click', function(this: HTMLElement, e: Event) {
      if (!isMobile) return;
      toggleExpansion.call(this, e);
    });

    // Add keyboard support for Enter key
    point.addEventListener('keydown', function(this: HTMLElement, e: KeyboardEvent) {
      if (e.key === 'Enter' || e.key === ' ') {
        toggleExpansion.call(this, e);
      }
    });

    // Desktop hover behavior
    if (!isMobile) {
      point.addEventListener('mouseenter', function(this: HTMLElement) {
        if (!isExpanded) {
          this.classList.add('expanded');
          this.setAttribute('aria-expanded', 'true');
          isExpanded = true;
        }
      });

      point.addEventListener('mouseleave', function(this: HTMLElement) {
        if (!this.contains(document.activeElement)) {
          this.classList.remove('expanded');
          this.setAttribute('aria-expanded', 'false');
          isExpanded = false;
        }
      });
    }
  });
</script>