---
// ResourceFilter.astro - Simple filtering for robodex resources
---

<style>
.resource-card {
  transition: all 0.3s ease;
  opacity: 1;
  transform: translateY(0);
}

.resource-card.hidden {
  opacity: 0;
  transform: translateY(-10px);
  pointer-events: none;
}

.filter-btn {
  transition: all 0.2s ease;
}

.filter-btn:hover {
  transform: translateY(-1px);
}

button.filter-btn.active {
  background-color: #FFCB05 !important;
  color: #00274C !important;
  border-color: #FFCB05 !important;
  transform: translateY(-1px) !important;
  box-shadow: 0 4px 12px rgba(255, 203, 5, 0.3) !important;
  font-weight: 600 !important;
  backdrop-filter: none !important;
}

button.filter-btn.active:hover {
  background-color: #FFCB05 !important;
  color: #00274C !important;
}

.resource-count {
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.description-text {
  color: rgb(107 114 128);
  font-style: italic;
  font-size: 0.9rem;
  line-height: 1.4;
  margin-top: 0.5rem;
  padding-left: 1rem;
  border-left: 3px solid rgba(255, 203, 5, 0.3);
  transition: all 0.2s ease;
}

.dark .description-text {
  color: rgb(156 163 175);
}

.resource-card:hover .description-text {
  border-left-color: rgba(255, 203, 5, 0.8);
  padding-left: 1.25rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const filterButtons = document.querySelectorAll('.filter-btn');
  const resourceCards = document.querySelectorAll('.resource-card');
  const searchInput = document.getElementById('search-input');
  
  // Define filter groups
  const programFilters = ['undergraduate', 'masters', 'phd'];
  const helpFilters = ['all', 'academic', 'career', 'community', 'support', 'research', 'international'];
  
  let activeFilters = {
    program: null,
    help: 'all'
  };
  let searchTerm = '';
  
  // Set initial state
  updateActiveButtons();
  updateDisplay();
  
  // Search functionality
  if (searchInput) {
    searchInput.addEventListener('input', function(e) {
      searchTerm = e.target.value.toLowerCase();
      updateDisplay();
    });
  }
  
  filterButtons.forEach(button => {
    button.addEventListener('click', function() {
      const filter = this.getAttribute('data-filter');
      console.log('Button clicked:', filter);
      
      // Determine which filter group this belongs to
      if (programFilters.includes(filter)) {
        // Toggle program filter (allow deselecting)
        activeFilters.program = activeFilters.program === filter ? null : filter;
      } else if (helpFilters.includes(filter)) {
        activeFilters.help = filter;
      }
      
      console.log('Active filters:', activeFilters);
      
      // Update active buttons
      updateActiveButtons();
      
      // Update display
      updateDisplay();
    });
  });
  
  function updateActiveButtons() {
    filterButtons.forEach(btn => {
      const filter = btn.getAttribute('data-filter');
      const isActive = filter === activeFilters.program || filter === activeFilters.help;
      
      if (isActive) {
        btn.classList.add('active');
        // Force the styling with direct style application
        btn.style.backgroundColor = '#FFCB05';
        btn.style.color = '#00274C';
        btn.style.borderColor = '#FFCB05';
        btn.style.fontWeight = '600';
        btn.style.transform = 'translateY(-1px)';
        btn.style.boxShadow = '0 4px 12px rgba(255, 203, 5, 0.3)';
      } else {
        btn.classList.remove('active');
        // Reset to original styling
        btn.style.backgroundColor = '';
        btn.style.color = '';
        btn.style.borderColor = '';
        btn.style.fontWeight = '';
        btn.style.transform = '';
        btn.style.boxShadow = '';
      }
    });
  }
  
  function updateDisplay() {
    let visibleCount = 0;
    
    resourceCards.forEach(card => {
      const categories = card.getAttribute('data-categories') || '';
      const categoryList = categories.split(' ');
      
      // Check program filter match
      const programMatch = !activeFilters.program || categoryList.includes(activeFilters.program);
      
      // Check help filter match  
      const helpMatch = activeFilters.help === 'all' || categoryList.includes(activeFilters.help);
      
      // Apply category filters to entire card
      if (!programMatch || !helpMatch) {
        card.classList.add('hidden');
        card.style.display = 'none';
        return;
      }
      
      // For search, check individual items within the card
      if (searchTerm) {
        const searchItems = card.querySelectorAll('li');
        let hasVisibleItems = false;
        
        searchItems.forEach(item => {
          const link = item.querySelector('a[data-search-terms]');
          if (link) {
            const itemText = item.textContent?.toLowerCase() || '';
            const searchTerms = link.getAttribute('data-search-terms')?.toLowerCase() || '';
            const itemMatches = itemText.includes(searchTerm) || searchTerms.includes(searchTerm);
            
            if (itemMatches) {
              item.style.display = '';
              hasVisibleItems = true;
            } else {
              item.style.display = 'none';
            }
          }
        });
        
        // Show/hide the entire card based on whether it has visible items
        if (hasVisibleItems) {
          card.classList.remove('hidden');
          card.style.display = 'block';
          visibleCount++;
        } else {
          card.classList.add('hidden');
          card.style.display = 'none';
        }
      } else {
        // No search term - show all items and the card
        const allItems = card.querySelectorAll('li');
        allItems.forEach(item => {
          item.style.display = '';
        });
        
        card.classList.remove('hidden');
        card.style.display = 'block';
        visibleCount++;
      }
    });
    
    updateCount(visibleCount);
  }
  
  function updateCount(visibleCount) {
    let countElement = document.querySelector('.resource-count');
    
    if (!countElement) {
      countElement = document.createElement('div');
      countElement.className = 'resource-count text-sm text-gray-500 dark:text-gray-400 text-center mt-6';
      document.querySelector('.masonry-container').parentNode.appendChild(countElement);
    }
    
    const totalCount = resourceCards.length;
    
    const activeFilterText = [];
    if (activeFilters.program) activeFilterText.push(activeFilters.program);
    if (activeFilters.help !== 'all') activeFilterText.push(activeFilters.help);
    if (searchTerm) activeFilterText.push(`search: "${searchTerm}"`);
    
    const filterDisplay = activeFilterText.length > 0 ? activeFilterText.join(' + ') : 'all';
    countElement.innerHTML = `Showing ${visibleCount} of ${totalCount} resources<br><small class="text-xs">Active filters: ${filterDisplay}</small>`;
  }
});
</script>